<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard — Smart Expense Tracker</title>

    {% load static %}

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

/* ------------------ GLOBAL ------------------ */
body {
    margin: 0;
    font-family: "Poppins", sans-serif;
    background: url('https://images.unsplash.com/photo-1526304640581-d334cdbbf45e')
        center/cover no-repeat fixed;
}

body::before {
    content:"";
    position: fixed;
    inset: 0;
    backdrop-filter: blur(8px);
    background: rgba(0,0,0,0.55);
    z-index: -1;
}

/* ------------------ GRID CONTAINER ------------------ */
.container {
    width: 95%;
    max-width: 1400px;
    margin: 20px auto;
    display: grid;
    gap: 20px;
}

/* Desktop layout */
@media(min-width: 992px) {
    .container {
        grid-template-columns: repeat(3, 1fr);
        grid-auto-rows: minmax(220px, auto);
    }
    .wide { grid-column: span 3; }
    .half { grid-column: span 2; }
}

/* Tablet layout */
@media (max-width: 991px) {
    .container {
        grid-template-columns: repeat(2, 1fr);
    }
    .wide { grid-column: span 2; }
    .half { grid-column: span 2; }
}

/* Mobile layout */
@media (max-width: 600px) {
    .container {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    .wide, .half {
        grid-column: span 1 !important;
    }
    h2 { font-size: 22px; }
    h3 { font-size: 18px; }
    p { font-size: 14px; }
}

/* ------------------ CARD ------------------ */
.card {
    background: rgba(0,0,0,0.45);
    border: 1px solid rgba(255,255,255,0.25);
    padding: 18px;
    border-radius: 14px;
    color: #ffffff !important;
    backdrop-filter: blur(14px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.5);
    width: 100%;
    box-sizing: border-box;
}

/* ------------------ TYPOGRAPHY ------------------ */
h2, h3 {
    margin: 6px 0;
    color: #00f5d4 !important;
    font-weight: 700;
}

p {
    color: #ffffff !important;
    font-size: 16px;
}

strong {
    color: #d7f7ff !important;
}

hr {
    border: 0;
    border-top: 1px solid rgba(255,255,255,0.25);
    margin: 8px 0 12px 0;
}

/* ------------------ BUTTON ------------------ */
button {
    width: 100%;
    padding: 12px;
    margin: 6px 0;
    border: none;
    border-radius: 10px;
    background: linear-gradient(135deg, #00c8a0, #00e0b5);
    color: #00332e !important;
    font-weight: 800;
    cursor: pointer;
}
button:hover { transform: scale(1.03); }

/* ------------------ CHART CONTAINER ------------------ */
.chart-wrapper {
    width: 100%;
    height: clamp(180px, 28vw, 260px); /* Responsive height */
}

canvas {
    width: 100% !important;
    height: 100% !important;
}

/* ------------------ DROPDOWN ------------------ */
select {
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    margin-top: 10px;
    background: rgba(255,255,255,0.2);
    color: #ffffff !important;
    border: none;
    outline: none;
}

/* ------------------ ALERT BANNER ------------------ */
.alert-banner {
    background: rgba(255, 80, 80, 0.9);
    color: white;
    padding: 14px;
    border-radius: 10px;
    font-weight: 700;
    margin-bottom: 15px;
    animation: fadeIn 0.6s ease-out;
    border: 1px solid rgba(255,160,160,0.5);
    box-shadow: 0 5px 15px rgba(255,0,0,0.4);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ------------------ LOGOUT LINK ------------------ */
.logout { 
    color: #ffb3b3 !important;
    font-weight: bold;
}

</style>
</head>

<body>

<div class="container">

    <!-- WELCOME CARD -->
    <div class="card wide">
        <h2>Welcome, {{ user_name }}</h2>
        <hr>

        {% if alert %}
        <div class="alert-banner">{{ alert }}</div>
        {% endif %}

        {% if budget %}
            <p><strong>Budget:</strong> ₹{{ budget.Amount }} ({{ budget.Period }})</p>

            {% if not alert %}
            <p style="color:#6bff8d; font-weight:bold;">
                Remaining Budget: {{ remaining }}
            </p>
            {% endif %}
        {% else %}
            <p>No budget set.</p>
        {% endif %}
    </div>

    <!-- QUICK ACTIONS -->
    <div class="card">
        <h3>Quick Actions</h3>

        <a href="{% url 'budget' %}"><button>Set / Update Budget</button></a>
        <a href="{% url 'create_expense' %}"><button>Add Expense</button></a>
        <a href="{% url 'expense_list' %}"><button>View Expenses</button></a>
        <a href="{% url 'expense_report' %}"><button>Reports</button></a>
        <a href="{% url 'income_list' %}"><button>View Income</button></a>
    </div>

    <!-- EXPENSE TREND CHART -->
    <div class="card half">
        <h3>Expense Trend</h3>

        <div class="chart-wrapper">
            <canvas id="expenseChart"></canvas>
        </div>

        <select id="periodSelect">
            <option value="monthly">Monthly</option>
            <option value="weekly">Weekly</option>
            <option value="yearly">Yearly</option>
        </select>
    </div>

    <!-- CATEGORY PIE CHART -->
    <div class="card">
        <h3>Expenses by Category</h3>

        <div class="chart-wrapper">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>

    <!-- FINANCIAL SUMMARY -->
    <div class="card">
        <h3>Financial Summary</h3>

        <p>Total Income: ₹{{ total_income }}</p>
        <p>Total Expense: ₹{{ total_expense }}</p>
        <p><strong>Balance: ₹{{ balance }}</strong></p>

        <br>
        <a href="{% url 'logout' %}" class="logout">Logout</a>
    </div>

</div>

<!-- ==================== EXPENSE TREND CHART ==================== -->
<script>
let expenseChart;

function loadExpenseChart(period="monthly") {
    fetch(`/chart-data/${period}/`)
        .then(r => r.json())
        .then(data => {

            if (!data.labels || data.labels.length === 0) {
                data.labels = ["No Data"];
                data.data = [0];
            }

            if (expenseChart) expenseChart.destroy();

            expenseChart = new Chart(document.getElementById("expenseChart"), {
                type: "line",
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: `${period} Expenses`,
                        data: data.data,
                        borderColor: "#00f5d4",
                        backgroundColor: "rgba(0,245,212,0.25)",
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: { color: "#ffffff", font: { size: 12 }},
                            grid: { color: "rgba(255,255,255,0.15)" }
                        },
                        y: {
                            ticks: { color: "#ffffff", font: { size: 12 }},
                            grid: { color: "rgba(255,255,255,0.15)" }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: "#ffffff" }}
                    }
                }
            });
        });
}

loadExpenseChart();

document.getElementById("periodSelect").addEventListener("change", function() {
    loadExpenseChart(this.value);
});
</script>

<!-- ==================== CATEGORY PIE CHART ==================== -->
<script>
fetch("{% url 'category_chart_data' %}")
    .then(r => r.json())
    .then(data => {

        if (!data.labels || data.labels.length === 0) {
            data.labels = ["No Categories"];
            data.data = [0];
        }

        new Chart(document.getElementById("categoryChart"), {
            type: "pie",
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.data,
                    backgroundColor: [
                        "#00f5d4","blue","orange","purple","red","green","yellow"
                    ],
                    borderColor: "#ffffff",
                    borderWidth: 2
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: "#ffffff" }},
                    tooltip: {
                        bodyColor: "#ffffff",
                        titleColor: "#ffffff"
                    }
                }
            }
        });
    });
</script>

<!-- ==================== VOICE ALERT ==================== -->
{% if alert %}
<script>
    const warning = new SpeechSynthesisUtterance("Warning! Budget exceeded!");
    warning.volume = 1;
    warning.rate = 1;
    warning.pitch = 1;
    speechSynthesis.speak(warning);
</script>
{% endif %}

</body>
</html>
